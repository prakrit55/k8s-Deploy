name: Helm Deploy to External Cluster
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AVM_HOST }}
          username: azureuser
          port: 22
          key: ${{ secrets.AVM_SSH_KEY }}
          source: "my-K8s-Deploy-App"
          target: "/home/azureuser/K8s-Deploy/"

          overwrite: true
      
      - name: Deploy with Helm
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AVM_HOST }}
          username: azureuser
          timeout: 3m  
          key: ${{ secrets.AVM_SSH_KEY }}
          script: |
            cd K8s-Deploy/my-K8s-Deploy-App
            if helm upgrade --install my-K8s-Deploy-App . -f values.yaml --wait --timeout=2m; then

              echo "✅ Deployment successful"
              helm status my-K8s-Deploy-App
              kubectl get pods -l app.kubernetes.io/name=k8s-deploy
            else
              echo "❌ Deployment failed"
              helm install my-K8s-Deploy-App . -f values.yaml
              helm status my-K8s-Deploy-App
              exit 1
            fi